<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Setup - Better Day Energy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1f4e79, #2563eb);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .debug-panel {
            background: #fff3cd;
            padding: 15px;
            margin: 20px;
            border-radius: 6px;
            border: 1px solid #ffc107;
            font-family: monospace;
            font-size: 14px;
        }
        
        .step-container {
            padding: 30px;
        }
        
        .step {
            display: none;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .step.active {
            display: block !important;
        }
        
        .step h3 {
            color: #1f4e79;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        .required {
            color: red;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-bar {
            background: #e9ecef;
            height: 8px;
            margin: 20px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: #28a745;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .error {
            border-color: #dc3545 !important;
            background-color: #fff5f5 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Customer Setup Document</h1>
            <p>Complete your Better Day Energy customer application</p>
        </div>
        
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 33%;"></div>
        </div>
        
        <div class="step-container">
            <form id="main-form">
                <!-- Step 1: Basic Info -->
                <div class="step active" id="step-1" data-step="1">
                    <h3>Step 1: Basic Business Information</h3>
                    
                    <div class="form-group">
                        <label for="business-name">Business Name <span class="required">*</span></label>
                        <input type="text" id="business-name" name="business_name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="business-type">Business Type <span class="required">*</span></label>
                        <select id="business-type" name="business_type" required>
                            <option value="">Select Type</option>
                            <option value="llc">LLC</option>
                            <option value="corporation">Corporation</option>
                            <option value="partnership">Partnership</option>
                            <option value="sole_proprietor">Sole Proprietor</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="years-business">Years in Business <span class="required">*</span></label>
                        <input type="number" id="years-business" name="years_business" min="0" required>
                    </div>
                    
                    <div class="navigation">
                        <button type="button" class="btn btn-secondary" onclick="saveProgress()">
                            üíæ Save Progress
                        </button>
                        <button type="button" class="btn btn-primary" onclick="goToStep(2)">
                            Next: Contact Info ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Contact Info -->
                <div class="step" id="step-2" data-step="2">
                    <h3>Step 2: Contact Information</h3>
                    
                    <div class="form-group">
                        <label for="contact-name">Primary Contact Name <span class="required">*</span></label>
                        <input type="text" id="contact-name" name="contact_name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contact-phone">Phone Number <span class="required">*</span></label>
                        <input type="tel" id="contact-phone" name="contact_phone" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contact-email">Email Address <span class="required">*</span></label>
                        <input type="email" id="contact-email" name="contact_email" required>
                    </div>
                    
                    <div class="navigation">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                            ‚Üê Previous
                        </button>
                        <div>
                            <button type="button" class="btn btn-secondary" onclick="saveProgress()" style="margin-right: 10px;">
                                üíæ Save Progress
                            </button>
                            <button type="button" class="btn btn-primary" onclick="goToStep(3)">
                                Next: Final Step ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Final Info -->
                <div class="step" id="step-3" data-step="3">
                    <h3>Step 3: Final Information</h3>
                    
                    <div class="form-group">
                        <label for="fuel-volume">Annual Fuel Volume (gallons) <span class="required">*</span></label>
                        <input type="number" id="fuel-volume" name="fuel_volume" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="locations">Number of Locations</label>
                        <input type="number" id="locations" name="locations" min="1" value="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Additional Notes</label>
                        <textarea id="notes" name="notes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px;"></textarea>
                    </div>
                    
                    <div class="navigation">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                            ‚Üê Previous
                        </button>
                        <div>
                            <button type="button" class="btn btn-secondary" onclick="saveProgress()" style="margin-right: 10px;">
                                üíæ Save Progress
                            </button>
                            <button type="submit" class="btn btn-success" id="submit-btn">
                                ‚úÖ Complete Application
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Manual save/load only - no auto-save
        let currentStep = 1;
        const totalSteps = 3;
        
        // Debug initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== FORM INITIALIZATION ===');
            
            // Initialize form sections
            const sections = document.querySelectorAll('.step');
            
            // Ensure step 1 is visible
            showStep(1);
            
            // Check for saved progress
            checkForSavedProgress();
            
            console.log('=== INITIALIZATION COMPLETE ===');
        });
        
        function showStep(stepNumber) {
            console.log(`=== SHOWING STEP ${stepNumber} ===`);
            
            try {
                // Hide all steps
                document.querySelectorAll('.step').forEach(step => {
                    step.classList.remove('active');
                    console.log('Hiding step:', step.id);
                });
                
                // Show target step
                const targetStep = document.getElementById(`step-${stepNumber}`);
                if (targetStep) {
                    targetStep.classList.add('active');
                    console.log('Showing step:', targetStep.id);
                    
                    // Update current step
                    currentStep = stepNumber;
                    
                    // Update progress bar
                    const progressPercent = (stepNumber / totalSteps) * 100;
                    document.getElementById('progress-fill').style.width = progressPercent + '%';
                    
                    // Scroll to top
                    targetStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    console.log(`Successfully showing step ${stepNumber}`);
                    return true;
                } else {
                    console.error(`Step ${stepNumber} not found!`);
                    alert(`Error: Step ${stepNumber} not found`);
                    return false;
                }
            } catch (error) {
                console.error('Error in showStep:', error);
                alert('Error changing steps: ' + error.message);
                return false;
            }
        }
        
        function validateCurrentStep() {
            console.log(`=== VALIDATING STEP ${currentStep} ===`);
            
            const currentStepElement = document.getElementById(`step-${currentStep}`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            let isValid = true;
            let firstError = null;
            
            console.log('Checking', requiredFields.length, 'required fields');
            
            requiredFields.forEach(field => {
                // Clear previous error styling
                field.classList.remove('error');
                
                if (!field.value.trim()) {
                    field.classList.add('error');
                    isValid = false;
                    if (!firstError) {
                        firstError = field;
                    }
                    console.log('Field is empty:', field.name);
                } else {
                    console.log('Field is valid:', field.name, '=', field.value);
                }
            });
            
            if (!isValid && firstError) {
                alert('Please fill in all required fields before proceeding.');
                firstError.focus();
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            console.log('Validation result:', isValid);
            return isValid;
        }
        
        function goToStep(stepNumber) {
            console.log(`=== GO TO STEP ${stepNumber} (from ${currentStep}) ===`);
            
            // If moving forward, validate current step
            if (stepNumber > currentStep) {
                if (!validateCurrentStep()) {
                    console.log('Validation failed, staying on current step');
                    return;
                }
            }
            
            // Change to new step
            if (showStep(stepNumber)) {
                console.log(`Successfully moved to step ${stepNumber}`);
            }
        }
        
        // Form submission
        document.getElementById('main-form').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('=== FORM SUBMISSION ===');
            
            // Validate final step
            if (!validateCurrentStep()) {
                return;
            }
            
            // Collect form data
            const formData = new FormData(this);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            console.log('Form data:', data);
            
            // Submit to API
            submitToAPI(data);
        });
        
        // API Submission
        async function submitToAPI(data) {
            try {
                console.log('Submitting to API...');
                
                const response = await fetch('https://loi-automation-api.onrender.com/api/v1/forms/customer-setup/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('API Response:', result);
                    
                    alert('üéâ Application submitted successfully!\n\n' + 
                          'Business: ' + data.business_name + '\n' +
                          'Contact: ' + data.contact_name + '\n' +
                          'Email: ' + data.contact_email + '\n\n' +
                          'Your application has been saved to the database.');
                    
                    // Clear saved progress since form is submitted
                    localStorage.removeItem('customer_setup_manual_save');
                    
                } else {
                    console.error('API Error:', response.status, response.statusText);
                    alert('‚ùå Submission failed. Please try again or contact support.');
                }
                
            } catch (error) {
                console.error('Network Error:', error);
                
                // Fallback - show data and save locally
                alert('‚ö†Ô∏è Could not connect to server.\n\n' + 
                      'Your data has been saved locally:\n\n' +
                      'Business: ' + data.business_name + '\n' +
                      'Contact: ' + data.contact_name + '\n' +
                      'Email: ' + data.contact_email + '\n\n' +
                      'Please try submitting again when connected.');
                
                // Save submission data for retry
                localStorage.setItem('customer_setup_pending_submission', JSON.stringify(data));
            }
        }
        
        // Save/Load Functions
        function saveProgress() {
            console.log('=== SAVING PROGRESS ===');
            
            const formData = new FormData(document.getElementById('main-form'));
            const data = { currentStep: currentStep };
            
            // Collect all form values
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            try {
                localStorage.setItem('customer_setup_manual_save', JSON.stringify(data));
                
                // Visual feedback
                const originalText = event.target.textContent;
                event.target.textContent = '‚úÖ Saved!';
                event.target.style.background = '#28a745';
                
                setTimeout(() => {
                    event.target.textContent = originalText;
                    event.target.style.background = '#6c757d';
                }, 2000);
                
                console.log('Progress saved successfully');
                alert('‚úÖ Progress saved! You can continue later.');
            } catch (error) {
                console.error('Error saving progress:', error);
                alert('‚ùå Error saving progress: ' + error.message);
            }
        }
        
        function loadProgress() {
            console.log('=== LOADING PROGRESS ===');
            
            try {
                const saved = localStorage.getItem('customer_setup_manual_save');
                if (!saved) {
                    console.log('No saved progress found');
                    return false;
                }
                
                const data = JSON.parse(saved);
                console.log('Found saved data:', data);
                
                // Restore form values
                for (let [key, value] of Object.entries(data)) {
                    if (key === 'currentStep') {
                        showStep(value);
                    } else {
                        const field = document.querySelector(`[name="${key}"]`);
                        if (field) {
                            field.value = value;
                            console.log(`Restored ${key} = ${value}`);
                        }
                    }
                }
                
                console.log('Progress loaded successfully');
                return true;
            } catch (error) {
                console.error('Error loading progress:', error);
                return false;
            }
        }
        
        function checkForSavedProgress() {
            const saved = localStorage.getItem('customer_setup_manual_save');
            if (saved) {
                if (confirm('üîÑ Found saved progress! Would you like to continue where you left off?')) {
                    loadProgress();
                } else {
                    // Clear saved data if user chooses not to continue
                    localStorage.removeItem('customer_setup_manual_save');
                }
            }
        }
        
        function clearSavedProgress() {
            localStorage.removeItem('customer_setup_manual_save');
            alert('üóëÔ∏è Saved progress cleared!');
            location.reload();
        }

        // Test functions (available in console)
        window.testStep1 = () => goToStep(1);
        window.testStep2 = () => goToStep(2);
        window.testStep3 = () => goToStep(3);
        window.fillTestData = () => {
            document.getElementById('business-name').value = 'Test Business';
            document.getElementById('business-type').value = 'llc';
            document.getElementById('years-business').value = '5';
            document.getElementById('contact-name').value = 'John Doe';
            document.getElementById('contact-phone').value = '555-1234';
            document.getElementById('contact-email').value = 'john@test.com';
            document.getElementById('fuel-volume').value = '100000';
            console.log('Test data filled');
        };
        
        window.clearSavedProgress = clearSavedProgress;
        
        console.log('Available test functions: testStep1(), testStep2(), testStep3(), fillTestData(), clearSavedProgress()');
    </script>
</body>
</html>