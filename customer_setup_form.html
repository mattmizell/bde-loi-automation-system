<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Day Energy Customer Setup Document</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1f4e79, #2563eb);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .crm-search {
            background: #e3f2fd;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .search-btn {
            padding: 12px 24px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .customer-result {
            background: white;
            padding: 15px;
            margin: 5px 0;
            border-radius: 6px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .customer-result:hover {
            background: #f8f9fa;
            border-color: #2563eb;
        }
        
        .progress-indicator {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            margin: 0 15px;
            font-size: 14px;
        }
        
        .progress-circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .progress-step.active .progress-circle {
            background: #2563eb;
            color: white;
        }
        
        .progress-step.completed .progress-circle {
            background: #28a745;
            color: white;
        }
        
        .form-content {
            padding: 40px;
        }
        
        .form-section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            display: none;
        }
        
        .form-section.active {
            display: block;
        }
        
        .form-section h3 {
            color: #1f4e79;
            margin-bottom: 25px;
            font-size: 20px;
            border-bottom: 2px solid #2563eb;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row.full-width {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group label .required {
            color: #dc3545;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        .form-group input.error {
            border-color: #dc3545;
            background-color: #fff5f5;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .reference-section {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
            background: white;
        }
        
        .add-reference-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .remove-reference-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }
        
        .signature-section {
            border: 2px solid #2563eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9ff;
        }
        
        .signature-canvas {
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: crosshair;
        }
        
        .signature-controls {
            margin-top: 10px;
            text-align: center;
        }
        
        .signature-controls button {
            margin: 0 5px;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .form-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e9ecef;
        }
        
        .save-progress {
            background: #ffc107;
            color: #212529;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .progress-indicator {
                flex-wrap: wrap;
            }
            
            .progress-step {
                margin: 5px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Better Day Energy Customer Setup Document</h1>
            <p>Complete Customer Onboarding & Credit Application</p>
        </div>
        
        <!-- CRM Search Section -->
        <div class="crm-search">
            <h4>üîç Search Existing Customers</h4>
            <p style="margin-bottom: 15px; color: #666;">Search our CRM to see if this customer already exists or to pre-fill information.</p>
            
            <div class="search-box">
                <input type="text" id="crm-search-input" class="search-input" placeholder="Search by company name, contact name, or email...">
                <button class="search-btn" onclick="searchCRM()">üîç Search CRM</button>
            </div>
            
            <div id="search-results" class="search-results" style="display: none;"></div>
        </div>
        
        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="progress-step active" data-step="1">
                <div class="progress-circle">1</div>
                <span>Business Info</span>
            </div>
            <div class="progress-step" data-step="2">
                <div class="progress-circle">2</div>
                <span>Contact Details</span>
            </div>
            <div class="progress-step" data-step="3">
                <div class="progress-circle">3</div>
                <span>Location & Equipment</span>
            </div>
            <div class="progress-step" data-step="4">
                <div class="progress-circle">4</div>
                <span>Financial & References</span>
            </div>
            <div class="progress-step" data-step="5">
                <div class="progress-circle">5</div>
                <span>Authorization</span>
            </div>
        </div>
        
        <div class="form-content">
            <form id="customer-setup-form">
                <!-- Step 1: Business Information -->
                <div class="form-section active" data-step="1" id="step-1">
                    <h3>üè¢ Step 1: Business Information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="legal-business-name">Legal Business Name <span class="required">*</span></label>
                            <input type="text" id="legal-business-name" name="legal_business_name" required>
                        </div>
                        <div class="form-group">
                            <label for="dba-name">DBA Name (if different)</label>
                            <input type="text" id="dba-name" name="dba_name">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="business-type">Business Type <span class="required">*</span></label>
                            <select id="business-type" name="business_type" required>
                                <option value="">Select Business Type</option>
                                <option value="corporation">Corporation</option>
                                <option value="llc">LLC</option>
                                <option value="partnership">Partnership</option>
                                <option value="sole_proprietor">Sole Proprietor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="years-in-business">Years in Business <span class="required">*</span></label>
                            <input type="number" id="years-in-business" name="years_in_business" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="federal-tax-id">Federal Tax ID (EIN) <span class="required">*</span></label>
                            <input type="text" id="federal-tax-id" name="federal_tax_id" pattern="[0-9]{2}-[0-9]{7}" placeholder="XX-XXXXXXX" required>
                        </div>
                        <div class="form-group">
                            <label for="state-tax-id">State Tax ID</label>
                            <input type="text" id="state-tax-id" name="state_tax_id">
                        </div>
                    </div>
                    
                    <div class="form-navigation">
                        <span></span>
                        <div>
                            <button type="button" class="btn save-progress" onclick="saveProgress()">üíæ Save Progress</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">Next: Contact Details ‚Üí</button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Contact Information -->
                <div class="form-section" data-step="2" id="step-2">
                    <h3>üë§ Step 2: Contact Information</h3>
                    
                    <h4>Primary Contact</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="primary-contact-name">Full Name <span class="required">*</span></label>
                            <input type="text" id="primary-contact-name" name="primary_contact_name" required>
                        </div>
                        <div class="form-group">
                            <label for="primary-contact-title">Title <span class="required">*</span></label>
                            <input type="text" id="primary-contact-title" name="primary_contact_title" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="primary-contact-phone">Phone Number <span class="required">*</span></label>
                            <input type="tel" id="primary-contact-phone" name="primary_contact_phone" required>
                        </div>
                        <div class="form-group">
                            <label for="primary-contact-email">Email Address <span class="required">*</span></label>
                            <input type="email" id="primary-contact-email" name="primary_contact_email" required>
                        </div>
                    </div>
                    
                    <h4>Accounts Payable Contact</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ap-contact-name">AP Contact Name <span class="required">*</span></label>
                            <input type="text" id="ap-contact-name" name="accounts_payable_contact" required>
                        </div>
                        <div class="form-group">
                            <label for="ap-contact-email">AP Email Address <span class="required">*</span></label>
                            <input type="email" id="ap-contact-email" name="accounts_payable_email" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ap-contact-phone">AP Phone Number <span class="required">*</span></label>
                            <input type="tel" id="ap-contact-phone" name="accounts_payable_phone" required>
                        </div>
                        <div class="form-group"></div>
                    </div>
                    
                    <div class="form-navigation">
                        <button type="button" class="btn btn-secondary" onclick="previousStep()">‚Üê Previous</button>
                        <div>
                            <button type="button" class="btn save-progress" onclick="saveProgress()">üíæ Save Progress</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">Next: Location & Equipment ‚Üí</button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Location & Equipment -->
                <div class="form-section" data-step="3" id="step-3">
                    <h3>üìç Step 3: Location & Equipment Information</h3>
                    
                    <h4>Physical Address</h4>
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="physical-address">Street Address <span class="required">*</span></label>
                            <input type="text" id="physical-address" name="physical_address" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="physical-city">City <span class="required">*</span></label>
                            <input type="text" id="physical-city" name="physical_city" required>
                        </div>
                        <div class="form-group">
                            <label for="physical-state">State <span class="required">*</span></label>
                            <input type="text" id="physical-state" name="physical_state" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="physical-zip">ZIP Code <span class="required">*</span></label>
                            <input type="text" id="physical-zip" name="physical_zip" required>
                        </div>
                        <div class="form-group"></div>
                    </div>
                    
                    <h4>Mailing Address</h4>
                    <div class="checkbox-group">
                        <input type="checkbox" id="same-as-physical" onchange="copyPhysicalAddress()">
                        <label for="same-as-physical">Same as physical address</label>
                    </div>
                    
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="mailing-address">Mailing Street Address</label>
                            <input type="text" id="mailing-address" name="mailing_address">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mailing-city">Mailing City</label>
                            <input type="text" id="mailing-city" name="mailing_city">
                        </div>
                        <div class="form-group">
                            <label for="mailing-state">Mailing State</label>
                            <input type="text" id="mailing-state" name="mailing_state">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mailing-zip">Mailing ZIP Code</label>
                            <input type="text" id="mailing-zip" name="mailing_zip">
                        </div>
                        <div class="form-group"></div>
                    </div>
                    
                    <h4>Business Details</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="annual-fuel-volume">Annual Fuel Volume (gallons) <span class="required">*</span></label>
                            <input type="number" id="annual-fuel-volume" name="annual_fuel_volume" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="number-of-locations">Number of Locations</label>
                            <input type="number" id="number-of-locations" name="number_of_locations" min="1" value="1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dispenser-count">Number of Dispensers <span class="required">*</span></label>
                            <input type="number" id="dispenser-count" name="dispenser_count" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="pos-system">POS System Brand</label>
                            <input type="text" id="pos-system" name="pos_system" placeholder="e.g., Verifone, Gilbarco, etc.">
                        </div>
                    </div>
                    
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="current-fuel-brands">Current Fuel Brands (comma-separated)</label>
                            <input type="text" id="current-fuel-brands" name="current_fuel_brands" placeholder="e.g., Shell, Mobil, BP">
                        </div>
                    </div>
                    
                    <div class="form-navigation">
                        <button type="button" class="btn btn-secondary" onclick="previousStep()">‚Üê Previous</button>
                        <div>
                            <button type="button" class="btn save-progress" onclick="saveProgress()">üíæ Save Progress</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">Next: Financial & References ‚Üí</button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: Financial & References -->
                <div class="form-section" data-step="4" id="step-4">
                    <h3>üí∞ Step 4: Financial Information & References</h3>
                    
                    <h4>Bank References</h4>
                    <div id="bank-references">
                        <div class="reference-section" data-ref-type="bank" data-ref-index="0">
                            <h5>Bank Reference 1 <span class="required">*</span></h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Bank Name <span class="required">*</span></label>
                                    <input type="text" name="bank_ref_0_name" required>
                                </div>
                                <div class="form-group">
                                    <label>Contact Person</label>
                                    <input type="text" name="bank_ref_0_contact">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone Number</label>
                                    <input type="tel" name="bank_ref_0_phone">
                                </div>
                                <div class="form-group">
                                    <label>Account Number</label>
                                    <input type="text" name="bank_ref_0_account">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-reference-btn" onclick="addReference('bank')">+ Add Another Bank Reference</button>
                    
                    <h4>Trade References</h4>
                    <div id="trade-references">
                        <div class="reference-section" data-ref-type="trade" data-ref-index="0">
                            <h5>Trade Reference 1 <span class="required">*</span></h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Company Name <span class="required">*</span></label>
                                    <input type="text" name="trade_ref_0_company" required>
                                </div>
                                <div class="form-group">
                                    <label>Contact Person</label>
                                    <input type="text" name="trade_ref_0_contact">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone Number</label>
                                    <input type="tel" name="trade_ref_0_phone">
                                </div>
                                <div class="form-group">
                                    <label>Monthly Credit Limit</label>
                                    <input type="number" name="trade_ref_0_credit_limit" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-reference-btn" onclick="addReference('trade')">+ Add Another Trade Reference</button>
                    
                    <div class="form-navigation">
                        <button type="button" class="btn btn-secondary" onclick="previousStep()">‚Üê Previous</button>
                        <div>
                            <button type="button" class="btn save-progress" onclick="saveProgress()">üíæ Save Progress</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">Next: Authorization ‚Üí</button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 5: Authorization & Signature -->
                <div class="form-section" data-step="5" id="step-5">
                    <h3>‚úçÔ∏è Step 5: Authorization & Electronic Signature</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="authorized-signer-name">Authorized Signer Name <span class="required">*</span></label>
                            <input type="text" id="authorized-signer-name" name="authorized_signer_name" required>
                        </div>
                        <div class="form-group">
                            <label for="authorized-signer-title">Authorized Signer Title <span class="required">*</span></label>
                            <input type="text" id="authorized-signer-title" name="authorized_signer_title" required>
                        </div>
                    </div>
                    
                    <div class="signature-section">
                        <h4>Electronic Signature <span class="required">*</span></h4>
                        <p style="margin-bottom: 15px; color: #666;">
                            I authorize Better Day Energy to proceed with credit application processing and account setup based on the information provided above.
                        </p>
                        
                        <canvas id="signature-canvas" class="signature-canvas" width="600" height="200"></canvas>
                        
                        <div class="signature-controls">
                            <button type="button" onclick="clearSignature()">Clear Signature</button>
                            <span style="margin: 0 20px; color: #666;">Sign above to complete application</span>
                        </div>
                        
                        <input type="hidden" id="signature-data" name="signature_data">
                        <input type="hidden" id="signature-date" name="signature_date">
                    </div>
                    
                    <div class="form-navigation">
                        <button type="button" class="btn btn-secondary" onclick="previousStep()">‚Üê Previous</button>
                        <div>
                            <button type="button" class="btn save-progress" onclick="saveProgress()">üíæ Save Progress</button>
                            <button type="submit" class="btn btn-success" id="submit-btn">‚úÖ Submit Application</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Application state
        let currentStep = 1;
        const totalSteps = 5;
        let signaturePad = null;
        let bankRefCount = 1;
        let tradeRefCount = 1;
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSignaturePad();
            checkForSavedProgress();
            updateProgressIndicator();
        });
        
        // CRM Search functionality
        async function searchCRM() {
            const query = document.getElementById('crm-search-input').value.trim();
            if (!query) return;
            
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;">üîç Searching CRM...</div>';
            resultsDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/v1/crm-bridge/contacts/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer bde_loi_auth_e6db5173a4393421ffadae85f9a3513e'
                    },
                    body: JSON.stringify({
                        query: query,
                        limit: 10
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayCRMResults(data.contacts);
                } else {
                    resultsDiv.innerHTML = '<div style="color: #dc3545; padding: 15px;">‚ùå CRM search unavailable</div>';
                }
            } catch (error) {
                console.error('CRM search error:', error);
                resultsDiv.innerHTML = '<div style="color: #dc3545; padding: 15px;">‚ùå Could not connect to CRM</div>';
            }
        }
        
        function displayCRMResults(contacts) {
            const resultsDiv = document.getElementById('search-results');
            
            if (!contacts || contacts.length === 0) {
                resultsDiv.innerHTML = '<div style="color: #666; padding: 15px;">No existing customers found. Continue with new customer setup.</div>';
                return;
            }
            
            let html = '<h5>Found Existing Customers:</h5>';
            contacts.forEach((contact, index) => {
                const safeContactId = (contact.contact_id || '').replace(/'/g, "\\'");
                const safeName = (contact.name || '').replace(/'/g, "\\'");
                const safeCompany = (contact.company_name || '').replace(/'/g, "\\'");
                const safeEmail = (contact.email || '').replace(/'/g, "\\'");
                const safePhone = (contact.phone || '').replace(/'/g, "\\'");
                
                html += `
                    <div class="customer-result" onclick="fillFromCRM('${safeContactId}', '${safeName}', '${safeCompany}', '${safeEmail}', '${safePhone}')">
                        <strong>${contact.company_name || contact.name}</strong><br>
                        <span style="color: #666;">${contact.name} ‚Ä¢ ${contact.email} ‚Ä¢ ${contact.phone}</span>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function fillFromCRM(contactId, name, companyName, email, phone) {
            // Fill form fields with CRM data
            if (companyName) document.getElementById('legal-business-name').value = companyName;
            if (name) document.getElementById('primary-contact-name').value = name;
            if (email) document.getElementById('primary-contact-email').value = email;
            if (phone) document.getElementById('primary-contact-phone').value = phone;
            
            // Hide search results
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('crm-search-input').value = '';
            
            alert(`‚úÖ Pre-filled information from CRM for: ${companyName || name}`);
        }
        
        // Step navigation
        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    currentStep++;
                    showStep(currentStep);
                }
            }
        }
        
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }
        
        function showStep(step) {
            // Hide all sections
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show target section
            document.getElementById(`step-${step}`).classList.add('active');
            
            // Update progress indicator
            updateProgressIndicator();
            
            // Scroll to top
            document.querySelector('.container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function updateProgressIndicator() {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                }
            });
        }
        
        function validateCurrentStep() {
            const currentSection = document.getElementById(`step-${currentStep}`);
            const requiredFields = currentSection.querySelectorAll('[required]');
            let isValid = true;
            let firstError = null;
            
            requiredFields.forEach(field => {
                field.classList.remove('error');
                
                if (!field.value.trim()) {
                    field.classList.add('error');
                    isValid = false;
                    if (!firstError) {
                        firstError = field;
                    }
                }
            });
            
            // Special validation for signature on step 5
            if (currentStep === 5) {
                if (!document.getElementById('signature-data').value) {
                    alert('Please provide your electronic signature to complete the application.');
                    return false;
                }
            }
            
            if (!isValid && firstError) {
                alert('Please fill in all required fields before proceeding.');
                firstError.focus();
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            return isValid;
        }
        
        // Reference management
        function addReference(type) {
            const container = document.getElementById(`${type}-references`);
            const count = type === 'bank' ? ++bankRefCount : ++tradeRefCount;
            const index = count - 1;
            
            const referenceHtml = type === 'bank' ? `
                <div class="reference-section" data-ref-type="${type}" data-ref-index="${index}">
                    <button type="button" class="remove-reference-btn" onclick="removeReference(this)">Remove</button>
                    <h5>Bank Reference ${count}</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bank Name</label>
                            <input type="text" name="bank_ref_${index}_name">
                        </div>
                        <div class="form-group">
                            <label>Contact Person</label>
                            <input type="text" name="bank_ref_${index}_contact">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" name="bank_ref_${index}_phone">
                        </div>
                        <div class="form-group">
                            <label>Account Number</label>
                            <input type="text" name="bank_ref_${index}_account">
                        </div>
                    </div>
                </div>
            ` : `
                <div class="reference-section" data-ref-type="${type}" data-ref-index="${index}">
                    <button type="button" class="remove-reference-btn" onclick="removeReference(this)">Remove</button>
                    <h5>Trade Reference ${count}</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Company Name</label>
                            <input type="text" name="trade_ref_${index}_company">
                        </div>
                        <div class="form-group">
                            <label>Contact Person</label>
                            <input type="text" name="trade_ref_${index}_contact">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" name="trade_ref_${index}_phone">
                        </div>
                        <div class="form-group">
                            <label>Monthly Credit Limit</label>
                            <input type="number" name="trade_ref_${index}_credit_limit" min="0">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', referenceHtml);
        }
        
        function removeReference(button) {
            button.closest('.reference-section').remove();
        }
        
        // Address copying
        function copyPhysicalAddress() {
            const checkbox = document.getElementById('same-as-physical');
            if (checkbox.checked) {
                document.getElementById('mailing-address').value = document.getElementById('physical-address').value;
                document.getElementById('mailing-city').value = document.getElementById('physical-city').value;
                document.getElementById('mailing-state').value = document.getElementById('physical-state').value;
                document.getElementById('mailing-zip').value = document.getElementById('physical-zip').value;
            } else {
                document.getElementById('mailing-address').value = '';
                document.getElementById('mailing-city').value = '';
                document.getElementById('mailing-state').value = '';
                document.getElementById('mailing-zip').value = '';
            }
        }
        
        // Signature pad functionality
        function initializeSignaturePad() {
            const canvas = document.getElementById('signature-canvas');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            
            // Set canvas size for high DPI displays
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
                updateSignatureData();
            }
            
            function stopDrawing() {
                isDrawing = false;
                ctx.beginPath();
                updateSignatureData();
            }
            
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            function updateSignatureData() {
                const dataURL = canvas.toDataURL('image/png');
                document.getElementById('signature-data').value = dataURL;
                document.getElementById('signature-date').value = new Date().toISOString();
            }
        }
        
        function clearSignature() {
            const canvas = document.getElementById('signature-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('signature-data').value = '';
            document.getElementById('signature-date').value = '';
        }
        
        // Save/Load functionality
        function saveProgress() {
            const formData = new FormData(document.getElementById('customer-setup-form'));
            const data = { currentStep: currentStep };
            
            // Collect form data
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Collect references
            data.bank_references = collectReferences('bank');
            data.trade_references = collectReferences('trade');
            
            try {
                localStorage.setItem('customer_setup_complete_save', JSON.stringify(data));
                
                // Visual feedback
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Saved!';
                button.style.background = '#28a745';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#ffc107';
                }, 2000);
                
                console.log('Progress saved successfully');
            } catch (error) {
                console.error('Error saving progress:', error);
                alert('‚ùå Error saving progress: ' + error.message);
            }
        }
        
        function checkForSavedProgress() {
            const saved = localStorage.getItem('customer_setup_complete_save');
            if (saved) {
                if (confirm('üîÑ Found saved progress! Would you like to continue where you left off?')) {
                    loadProgress();
                } else {
                    localStorage.removeItem('customer_setup_complete_save');
                }
            }
        }
        
        function loadProgress() {
            try {
                const saved = localStorage.getItem('customer_setup_complete_save');
                if (!saved) return false;
                
                const data = JSON.parse(saved);
                
                // Restore form values
                for (let [key, value] of Object.entries(data)) {
                    if (key === 'currentStep') {
                        currentStep = value;
                        showStep(currentStep);
                    } else if (key !== 'bank_references' && key !== 'trade_references') {
                        const field = document.querySelector(`[name="${key}"]`);
                        if (field) {
                            field.value = value;
                        }
                    }
                }
                
                // TODO: Restore references
                
                return true;
            } catch (error) {
                console.error('Error loading progress:', error);
                return false;
            }
        }
        
        function collectReferences(type) {
            const references = [];
            const sections = document.querySelectorAll(`[data-ref-type="${type}"]`);
            
            sections.forEach(section => {
                const index = section.dataset.refIndex;
                const ref = {};
                
                const inputs = section.querySelectorAll('input');
                inputs.forEach(input => {
                    const fieldName = input.name.split('_').slice(2).join('_');
                    ref[fieldName] = input.value;
                });
                
                // Only add if at least one field is filled
                if (Object.values(ref).some(value => value.trim())) {
                    references.push(ref);
                }
            });
            
            return references;
        }
        
        // Form submission
        document.getElementById('customer-setup-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateCurrentStep()) {
                return;
            }
            
            // Collect all form data
            const formData = new FormData(this);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Add references
            data.bank_references = collectReferences('bank');
            data.trade_references = collectReferences('trade');
            
            // Split current_fuel_brands into array
            if (data.current_fuel_brands) {
                data.current_fuel_brands = data.current_fuel_brands.split(',').map(s => s.trim()).filter(s => s);
            }
            
            console.log('Submitting form data:', data);
            
            try {
                const response = await fetch('/api/v1/forms/customer-setup/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('API Response:', result);
                    
                    alert('üéâ Customer setup application submitted successfully!\n\n' + 
                          'Business: ' + data.legal_business_name + '\n' +
                          'Contact: ' + data.primary_contact_name + '\n' +
                          'Email: ' + data.primary_contact_email + '\n\n' +
                          'Application ID: ' + result.id + '\n\n' +
                          'Your application has been saved to our database and will be processed within 2-3 business days.');
                    
                    // Clear saved progress
                    localStorage.removeItem('customer_setup_complete_save');
                    
                    // Redirect to completion page if available
                    if (result.id) {
                        window.location.href = `/api/v1/forms/customer-setup/complete/${result.id}`;
                    }
                    
                } else {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    alert('‚ùå Submission failed. Please try again or contact support.\n\nError: ' + response.status + ' - ' + errorText);
                }
                
            } catch (error) {
                console.error('Network Error:', error);
                alert('‚ö†Ô∏è Could not connect to server.\n\n' + 
                      'Your application has been saved locally and you can try submitting again when connected.\n\n' +
                      'Business: ' + data.legal_business_name + '\n' +
                      'Contact: ' + data.primary_contact_name);
                
                // Save for retry
                localStorage.setItem('customer_setup_pending_submission', JSON.stringify(data));
            }
        });
        
        // Allow Enter key on search
        document.getElementById('crm-search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCRM();
            }
        });
    </script>
</body>
</html>