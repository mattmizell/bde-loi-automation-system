<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Setup Document - Better Day Energy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1f4e79, #2563eb);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .progress-indicator {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        
        .progress-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .progress-step.active .progress-circle {
            background: #2563eb;
            color: white;
        }
        
        .progress-step.completed .progress-circle {
            background: #28a745;
            color: white;
        }
        
        .form-content {
            padding: 40px;
        }
        
        .form-section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            display: none;
        }
        
        .form-section.active {
            display: block;
        }
        
        .form-section h3 {
            color: #1f4e79;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group label .required {
            color: #dc3545;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .reference-container {
            margin-bottom: 20px;
        }
        
        .reference-item {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
        }
        
        .add-reference-btn {
            background: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .add-reference-btn:hover {
            background: #138496;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            float: right;
        }
        
        .signature-section {
            margin-top: 40px;
            padding: 30px;
            background: #e3f2fd;
            border-radius: 8px;
            border: 1px solid #bbdefb;
        }
        
        .signature-pad-container {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin: 20px 0;
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .signature-pad {
            display: block;
            width: 100%;
            height: 200px;
            cursor: crosshair;
            touch-action: none;
        }
        
        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #adb5bd;
            font-style: italic;
            pointer-events: none;
            font-size: 18px;
        }
        
        .signature-placeholder.hidden {
            display: none;
        }
        
        .signature-controls {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1f4e79;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            font-size: 18px;
            padding: 15px 30px;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .form-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e9ecef;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-info {
            background: #cfe2ff;
            border: 1px solid #b6d4fe;
            color: #084298;
        }
        
        .legal-notice {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #bbdefb;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1f4e79;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .form-content {
                padding: 20px;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .progress-indicator {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📋 Customer Setup Document</h1>
            <p>Complete your Better Day Energy fuel partnership application</p>
        </div>
        
        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="progress-step active" data-step="1">
                <div class="progress-circle">1</div>
                <span>Business Info</span>
            </div>
            <div class="progress-step" data-step="2">
                <div class="progress-circle">2</div>
                <span>Contact Details</span>
            </div>
            <div class="progress-step" data-step="3">
                <div class="progress-circle">3</div>
                <span>Equipment</span>
            </div>
            <div class="progress-step" data-step="4">
                <div class="progress-circle">4</div>
                <span>References</span>
            </div>
            <div class="progress-step" data-step="5">
                <div class="progress-circle">5</div>
                <span>Authorization</span>
            </div>
        </div>
        
        <div class="form-content">
            <form id="customer-setup-form">
                <!-- Step 1: Business Information -->
                <div class="form-section active" data-step="1">
                    <h3>🏢 Business Information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="legal-name">Legal Business Name <span class="required">*</span></label>
                            <input type="text" id="legal-name" name="legal_business_name" required>
                        </div>
                        <div class="form-group">
                            <label for="dba-name">DBA Name (if different)</label>
                            <input type="text" id="dba-name" name="dba_name">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="business-type">Business Type <span class="required">*</span></label>
                            <select id="business-type" name="business_type" required>
                                <option value="">Select Business Type</option>
                                <option value="corporation">Corporation</option>
                                <option value="llc">LLC</option>
                                <option value="partnership">Partnership</option>
                                <option value="sole_proprietor">Sole Proprietor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="years-business">Years in Business <span class="required">*</span></label>
                            <input type="number" id="years-business" name="years_in_business" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="federal-tax-id">Federal Tax ID (EIN) <span class="required">*</span></label>
                            <input type="text" id="federal-tax-id" name="federal_tax_id" pattern="[0-9]{2}-[0-9]{7}" placeholder="XX-XXXXXXX" required>
                        </div>
                        <div class="form-group">
                            <label for="state-tax-id">State Tax ID</label>
                            <input type="text" id="state-tax-id" name="state_tax_id">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="physical-address">Physical Address <span class="required">*</span></label>
                            <input type="text" id="physical-address" name="physical_address" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="physical-city">City <span class="required">*</span></label>
                            <input type="text" id="physical-city" name="physical_city" required>
                        </div>
                        <div class="form-group">
                            <label for="physical-state">State <span class="required">*</span></label>
                            <input type="text" id="physical-state" name="physical_state" maxlength="2" required>
                        </div>
                        <div class="form-group">
                            <label for="physical-zip">ZIP Code <span class="required">*</span></label>
                            <input type="text" id="physical-zip" name="physical_zip" pattern="[0-9]{5}(-[0-9]{4})?" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="same-mailing" onchange="toggleMailingAddress()">
                            Mailing address same as physical address
                        </label>
                    </div>
                    
                    <div id="mailing-address-section">
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="mailing-address">Mailing Address</label>
                                <input type="text" id="mailing-address" name="mailing_address">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mailing-city">City</label>
                                <input type="text" id="mailing-city" name="mailing_city">
                            </div>
                            <div class="form-group">
                                <label for="mailing-state">State</label>
                                <input type="text" id="mailing-state" name="mailing_state" maxlength="2">
                            </div>
                            <div class="form-group">
                                <label for="mailing-zip">ZIP Code</label>
                                <input type="text" id="mailing-zip" name="mailing_zip" pattern="[0-9]{5}(-[0-9]{4})?">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-navigation">
                        <span></span>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            Next: Contact Details →
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Contact Information -->
                <div class="form-section" data-step="2">
                    <h3>👤 Contact Information</h3>
                    
                    <h4>Primary Contact</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="primary-name">Full Name <span class="required">*</span></label>
                            <input type="text" id="primary-name" name="primary_contact_name" required>
                        </div>
                        <div class="form-group">
                            <label for="primary-title">Title <span class="required">*</span></label>
                            <input type="text" id="primary-title" name="primary_contact_title" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="primary-phone">Phone Number <span class="required">*</span></label>
                            <input type="tel" id="primary-phone" name="primary_contact_phone" required>
                        </div>
                        <div class="form-group">
                            <label for="primary-email">Email Address <span class="required">*</span></label>
                            <input type="email" id="primary-email" name="primary_contact_email" required>
                        </div>
                    </div>
                    
                    <hr style="margin: 30px 0;">
                    
                    <h4>Accounts Payable Contact</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ap-name">Full Name <span class="required">*</span></label>
                            <input type="text" id="ap-name" name="accounts_payable_contact" required>
                        </div>
                        <div class="form-group">
                            <label for="ap-phone">Phone Number <span class="required">*</span></label>
                            <input type="tel" id="ap-phone" name="accounts_payable_phone" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ap-email">Email Address <span class="required">*</span></label>
                            <input type="email" id="ap-email" name="accounts_payable_email" required>
                        </div>
                    </div>
                    
                    <div class="form-navigation">
                        <button type="button" class="btn btn-secondary" onclick="previousStep()">
                            ← Previous
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            Next: Equipment →
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Equipment Information -->
                <div class="form-section" data-step="3">
                    <h3>⛽ Equipment & Operations</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="locations">Number of Locations <span class="required">*</span></label>
                            <input type="number" id="locations" name="number_of_locations" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="fuel-volume">Annual Fuel Volume (gallons) <span class="required">*</span></label>
                            <input type="number" id="fuel-volume" name="annual_fuel_volume" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dispenser-count">Number of Dispensers <span class="required">*</span></label>
                            <input type="number" id="dispenser-count" name="dispenser_count" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="pos-system">POS System <span class="required">*</span></label>
                            <input type="text" id="pos-system" name="pos_system" placeholder="e.g., Verifone, Gilbarco" required>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="current-brands">Current Fuel Brands (comma-separated)</label>
                        <input type="text" id="current-brands" name="current_fuel_brands" placeholder="e.g., Shell, BP, Exxon">
                    </div>
                    
                    <h4 style="margin-top: 30px;">Tank Configuration</h4>
                    <div id="tank-container">
                        <div class="reference-item">
                            <button type="button" class="remove-btn" onclick="removeTank(this)">Remove</button>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tank Size (gallons)</label>
                                    <input type="number" name="tank_size[]" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Product Type</label>
                                    <select name="tank_product[]">
                                        <option value="">Select Product</option>
                                        <option value="regular">Regular Unleaded</option>
                                        <option value="plus">Plus</option>
                                        <option value="premium">Premium</option>
                                        <option value="diesel">Diesel</option>
                                        <option value="def">DEF</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-reference-btn" onclick="addTank()">
                        + Add Another Tank
                    </button>
                    
                    <div class="form-navigation">
                        <button type="button" class="btn btn-secondary" onclick="previousStep()">
                            ← Previous
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            Next: References →
                        </button>
                    </div>
                </div>
                
                <!-- Step 4: References -->
                <div class="form-section" data-step="4">
                    <h3>🏦 Financial References</h3>
                    
                    <h4>Bank References</h4>
                    <div id="bank-references-container">
                        <div class="reference-item">
                            <button type="button" class="remove-btn" onclick="removeReference(this)">Remove</button>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Bank Name</label>
                                    <input type="text" name="bank_ref_name[]">
                                </div>
                                <div class="form-group">
                                    <label>Contact Person</label>
                                    <input type="text" name="bank_ref_contact[]">
                                </div>
                                <div class="form-group">
                                    <label>Phone Number</label>
                                    <input type="tel" name="bank_ref_phone[]">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-reference-btn" onclick="addBankReference()">
                        + Add Bank Reference
                    </button>
                    
                    <hr style="margin: 30px 0;">
                    
                    <h4>Trade References</h4>
                    <div id="trade-references-container">
                        <div class="reference-item">
                            <button type="button" class="remove-btn" onclick="removeReference(this)">Remove</button>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Company Name</label>
                                    <input type="text" name="trade_ref_name[]">
                                </div>
                                <div class="form-group">
                                    <label>Contact Person</label>
                                    <input type="text" name="trade_ref_contact[]">
                                </div>
                                <div class="form-group">
                                    <label>Phone Number</label>
                                    <input type="tel" name="trade_ref_phone[]">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-reference-btn" onclick="addTradeReference()">
                        + Add Trade Reference
                    </button>
                    
                    <div class="form-navigation">
                        <button type="button" class="btn btn-secondary" onclick="previousStep()">
                            ← Previous
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            Next: Authorization →
                        </button>
                    </div>
                </div>
                
                <!-- Step 5: Authorization & Signature -->
                <div class="form-section" data-step="5">
                    <h3>✍️ Authorization & Agreement</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="signer-name">Authorized Signer Name <span class="required">*</span></label>
                            <input type="text" id="signer-name" name="authorized_signer_name" required>
                        </div>
                        <div class="form-group">
                            <label for="signer-title">Title <span class="required">*</span></label>
                            <input type="text" id="signer-title" name="authorized_signer_title" required>
                        </div>
                    </div>
                    
                    <div class="legal-notice">
                        <h4>Terms and Conditions</h4>
                        <p>By signing below, I certify that:</p>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>All information provided in this application is true and accurate</li>
                            <li>I am authorized to enter into agreements on behalf of the business</li>
                            <li>I agree to the Better Day Energy terms and conditions</li>
                            <li>I authorize Better Day Energy to verify all information provided</li>
                            <li>I understand that credit approval is required for fuel supply</li>
                        </ul>
                    </div>
                    
                    <!-- Signature Section -->
                    <div class="signature-section">
                        <h4>Electronic Signature Required</h4>
                        <p>Please sign below to complete your application:</p>
                        
                        <div class="signature-pad-container">
                            <canvas id="signature-pad" class="signature-pad" width="820" height="200"></canvas>
                            <div id="signature-placeholder" class="signature-placeholder">
                                Sign here with your mouse or touch device
                            </div>
                            
                            <div class="signature-controls">
                                <button type="button" id="clear-signature" class="btn btn-secondary">
                                    🗑️ Clear Signature
                                </button>
                                <span id="signature-status" style="color: #6c757d; font-style: italic;">
                                    Signature required
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-navigation">
                        <button type="button" class="btn btn-secondary" onclick="previousStep()">
                            ← Previous
                        </button>
                        <button type="submit" id="submit-btn" class="btn btn-success" disabled>
                            ✅ Submit Application
                        </button>
                    </div>
                </div>
            </form>
            
            <!-- Loading State -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Processing your application...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Multi-step form functionality
        let currentStep = 1;
        const totalSteps = 5;
        
        function showStep(step) {
            // Hide all sections
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show current section
            document.querySelector(`[data-step="${step}"]`).classList.add('active');
            
            // Update progress indicators
            document.querySelectorAll('.progress-step').forEach((indicator, index) => {
                if (index + 1 < step) {
                    indicator.classList.add('completed');
                    indicator.classList.remove('active');
                } else if (index + 1 === step) {
                    indicator.classList.add('active');
                    indicator.classList.remove('completed');
                } else {
                    indicator.classList.remove('active', 'completed');
                }
            });
            
            currentStep = step;
        }
        
        function nextStep() {
            if (validateStep(currentStep)) {
                if (currentStep < totalSteps) {
                    showStep(currentStep + 1);
                }
            }
        }
        
        function previousStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }
        
        function validateStep(step) {
            const section = document.querySelector(`.form-section[data-step="${step}"]`);
            const requiredFields = section.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#dc3545';
                    isValid = false;
                } else {
                    field.style.borderColor = '#e9ecef';
                }
            });
            
            if (!isValid) {
                alert('Please fill in all required fields before proceeding.');
            }
            
            return isValid;
        }
        
        // Mailing address toggle
        function toggleMailingAddress() {
            const checkbox = document.getElementById('same-mailing');
            const mailingSection = document.getElementById('mailing-address-section');
            
            if (checkbox.checked) {
                mailingSection.style.display = 'none';
                // Copy physical to mailing
                document.getElementById('mailing-address').value = document.getElementById('physical-address').value;
                document.getElementById('mailing-city').value = document.getElementById('physical-city').value;
                document.getElementById('mailing-state').value = document.getElementById('physical-state').value;
                document.getElementById('mailing-zip').value = document.getElementById('physical-zip').value;
            } else {
                mailingSection.style.display = 'block';
            }
        }
        
        // Dynamic reference management
        function addBankReference() {
            const container = document.getElementById('bank-references-container');
            const newRef = container.children[0].cloneNode(true);
            newRef.querySelectorAll('input').forEach(input => input.value = '');
            container.appendChild(newRef);
        }
        
        function addTradeReference() {
            const container = document.getElementById('trade-references-container');
            const newRef = container.children[0].cloneNode(true);
            newRef.querySelectorAll('input').forEach(input => input.value = '');
            container.appendChild(newRef);
        }
        
        function addTank() {
            const container = document.getElementById('tank-container');
            const newTank = container.children[0].cloneNode(true);
            newTank.querySelectorAll('input, select').forEach(field => field.value = '');
            container.appendChild(newTank);
        }
        
        function removeReference(btn) {
            const container = btn.closest('.reference-container, #bank-references-container, #trade-references-container, #tank-container');
            if (container.children.length > 1) {
                btn.closest('.reference-item').remove();
            } else {
                alert('At least one reference must remain.');
            }
        }
        
        function removeTank(btn) {
            const container = document.getElementById('tank-container');
            if (container.children.length > 1) {
                btn.closest('.reference-item').remove();
            } else {
                alert('At least one tank must remain.');
            }
        }
        
        // Signature pad functionality
        const canvas = document.getElementById('signature-pad');
        const ctx = canvas.getContext('2d');
        const placeholder = document.getElementById('signature-placeholder');
        const clearButton = document.getElementById('clear-signature');
        const submitButton = document.getElementById('submit-btn');
        const signatureStatus = document.getElementById('signature-status');
        const form = document.getElementById('customer-setup-form');
        const loading = document.getElementById('loading');
        
        let isDrawing = false;
        let hasSignature = false;
        
        // Canvas setup
        function setupCanvas() {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            return { scaleX, scaleY };
        }
        
        const { scaleX, scaleY } = setupCanvas();
        
        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events for mobile
        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', handleTouch);
        canvas.addEventListener('touchend', stopDrawing);
        
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            ctx.beginPath();
            ctx.moveTo(x, y);
            
            if (!hasSignature) {
                placeholder.classList.add('hidden');
                hasSignature = true;
                updateSignatureStatus();
            }
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.beginPath();
            }
        }
        
        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasSignature = false;
            placeholder.classList.remove('hidden');
            updateSignatureStatus();
        }
        
        function updateSignatureStatus() {
            if (hasSignature) {
                signatureStatus.textContent = 'Signature captured ✓';
                signatureStatus.style.color = '#28a745';
                checkFormValidity();
            } else {
                signatureStatus.textContent = 'Signature required';
                signatureStatus.style.color = '#6c757d';
                submitButton.disabled = true;
            }
        }
        
        function checkFormValidity() {
            const allRequiredFields = form.querySelectorAll('[required]');
            let allValid = true;
            
            allRequiredFields.forEach(field => {
                if (!field.value.trim()) {
                    allValid = false;
                }
            });
            
            submitButton.disabled = !(allValid && hasSignature);
        }
        
        // Event listeners
        clearButton.addEventListener('click', clearSignature);
        form.addEventListener('input', () => {
            if (currentStep === totalSteps) {
                checkFormValidity();
            }
        });
        
        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!hasSignature) {
                alert('Please provide your signature before submitting.');
                return;
            }
            
            // Validate all steps
            for (let i = 1; i <= totalSteps; i++) {
                if (!validateStep(i)) {
                    showStep(i);
                    return;
                }
            }
            
            // Show loading
            form.style.display = 'none';
            loading.style.display = 'block';
            
            // Collect form data
            const formData = new FormData(form);
            const data = {};
            
            // Convert FormData to object
            for (let [key, value] of formData.entries()) {
                if (key.endsWith('[]')) {
                    const cleanKey = key.slice(0, -2);
                    if (!data[cleanKey]) data[cleanKey] = [];
                    data[cleanKey].push(value);
                } else {
                    data[key] = value;
                }
            }
            
            // Add signature data
            data.signature_data = canvas.toDataURL('image/png');
            data.signature_date = new Date().toISOString();
            
            // Process references
            data.bank_references = [];
            const bankNames = formData.getAll('bank_ref_name[]');
            const bankContacts = formData.getAll('bank_ref_contact[]');
            const bankPhones = formData.getAll('bank_ref_phone[]');
            
            for (let i = 0; i < bankNames.length; i++) {
                if (bankNames[i]) {
                    data.bank_references.push({
                        name: bankNames[i],
                        contact: bankContacts[i],
                        phone: bankPhones[i]
                    });
                }
            }
            
            data.trade_references = [];
            const tradeNames = formData.getAll('trade_ref_name[]');
            const tradeContacts = formData.getAll('trade_ref_contact[]');
            const tradePhones = formData.getAll('trade_ref_phone[]');
            
            for (let i = 0; i < tradeNames.length; i++) {
                if (tradeNames[i]) {
                    data.trade_references.push({
                        name: tradeNames[i],
                        contact: tradeContacts[i],
                        phone: tradePhones[i]
                    });
                }
            }
            
            // Process tanks
            data.tank_sizes = [];
            const tankSizes = formData.getAll('tank_size[]');
            const tankProducts = formData.getAll('tank_product[]');
            
            for (let i = 0; i < tankSizes.length; i++) {
                if (tankSizes[i]) {
                    data.tank_sizes.push({
                        size: tankSizes[i],
                        product: tankProducts[i]
                    });
                }
            }
            
            // Convert current brands to array
            if (data.current_fuel_brands) {
                data.current_fuel_brands = data.current_fuel_brands.split(',').map(brand => brand.trim());
            }
            
            try {
                // Submit to API
                const response = await fetch('/api/v1/forms/customer-setup/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    window.location.href = `/forms/customer-setup/complete/${result.id}`;
                } else {
                    throw new Error('Failed to submit form');
                }
            } catch (error) {
                loading.style.display = 'none';
                form.style.display = 'block';
                alert('Error submitting form. Please try again.');
            }
        });
        
        // Save progress functionality
        function saveProgress() {
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (!data[key]) {
                    data[key] = value;
                } else {
                    if (!Array.isArray(data[key])) {
                        data[key] = [data[key]];
                    }
                    data[key].push(value);
                }
            }
            
            data.currentStep = currentStep;
            
            if (hasSignature) {
                data.signature_data = canvas.toDataURL('image/png');
            }
            
            localStorage.setItem('customer_setup_draft', JSON.stringify(data));
            alert('Progress saved!');
        }
        
        // Auto-save every 30 seconds
        setInterval(saveProgress, 30000);
        
        // Load saved progress on page load
        window.addEventListener('load', () => {
            const draft = localStorage.getItem('customer_setup_draft');
            if (draft) {
                const data = JSON.parse(draft);
                
                // Restore form fields
                Object.keys(data).forEach(key => {
                    if (key !== 'signature_data' && key !== 'currentStep') {
                        const field = form.elements[key];
                        if (field) {
                            field.value = data[key];
                        }
                    }
                });
                
                // Restore signature
                if (data.signature_data) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                        hasSignature = true;
                        placeholder.classList.add('hidden');
                        updateSignatureStatus();
                    };
                    img.src = data.signature_data;
                }
                
                // Restore step
                if (data.currentStep) {
                    showStep(data.currentStep);
                }
            }
        });
    </script>
</body>
</html>